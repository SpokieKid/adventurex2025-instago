<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InstaGo å›¾ç‰‡ç®¡ç†ç³»ç»Ÿæµ‹è¯•</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        h2 {
            color: #555;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        .error {
            border-left-color: #dc3545;
            background-color: #f8d7da;
        }
        .success {
            border-left-color: #28a745;
            background-color: #d4edda;
        }
        .image-preview {
            max-width: 300px;
            max-height: 300px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .api-section {
            margin-bottom: 40px;
        }
        pre {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>ğŸ–¼ï¸ InstaGo å›¾ç‰‡ç®¡ç†ç³»ç»Ÿæµ‹è¯•</h1>
    
    <!-- ä¸Šä¼ å›¾ç‰‡æµ‹è¯• -->
    <div class="container api-section">
        <h2>ğŸ“¤ ä¸Šä¼ æˆªå›¾</h2>
        <div class="form-group">
            <label for="imageFile">é€‰æ‹©å›¾ç‰‡æ–‡ä»¶:</label>
            <input type="file" id="imageFile" accept="image/*">
        </div>
        <div class="form-group">
            <label for="screenshotTimestamp">æˆªå›¾æ—¶é—´æˆ³ (å¯é€‰):</label>
            <input type="number" id="screenshotTimestamp" placeholder="Unixæ—¶é—´æˆ³ï¼Œç•™ç©ºåˆ™ä½¿ç”¨å½“å‰æ—¶é—´">
        </div>
        <div class="form-group">
            <label for="screenshotAppName">åº”ç”¨åç§° (å¯é€‰):</label>
            <input type="text" id="screenshotAppName" placeholder="ä¾‹å¦‚ï¼šPreview, Chrome, VSCode">
        </div>
        <div class="form-group">
            <label for="screenshotTags">æ ‡ç­¾ (å¯é€‰ï¼Œæœ€å¤š16å­—ç¬¦):</label>
            <input type="text" id="screenshotTags" placeholder="ä¾‹å¦‚ï¼šå·¥ä½œä¸­, å­¦ä¹ " maxlength="16">
        </div>
        <button onclick="uploadImage()">ä¸Šä¼ å¹¶åˆ†ææˆªå›¾</button>
        <div id="uploadResult" class="result" style="display:none;"></div>
        <img id="imagePreview" class="image-preview" style="display:none;">
    </div>

    <!-- è¯­ä¹‰æœç´¢æµ‹è¯• -->
    <div class="container api-section">
        <h2>ğŸ” è¯­ä¹‰æœç´¢</h2>
        <div class="form-group">
            <label for="searchQuery">æœç´¢æŸ¥è¯¢:</label>
            <input type="text" id="searchQuery" placeholder="ä¾‹å¦‚ï¼šè“è‰²çš„å¤©ç©ºã€å¯çˆ±çš„å°çŒ«ã€ç¾ä¸½çš„é£æ™¯...">
        </div>
        <div class="form-group">
            <label for="searchLimit">ç»“æœæ•°é‡é™åˆ¶:</label>
            <input type="number" id="searchLimit" value="5" min="1" max="20">
        </div>
        <button onclick="searchImages()">æœç´¢å›¾ç‰‡</button>
        <div id="searchResult" class="result" style="display:none;"></div>
    </div>

    <!-- æ–‡ä»¶å¤¹ç®¡ç†æµ‹è¯• -->
    <div class="container api-section">
        <h2>ğŸ“ æ–‡ä»¶å¤¹ç®¡ç†</h2>
        <div class="form-group">
            <label for="folderName">æ–‡ä»¶å¤¹åç§°:</label>
            <input type="text" id="folderName" placeholder="è¾“å…¥æ–°æ–‡ä»¶å¤¹åç§°">
        </div>
        <div class="form-group">
            <label for="parentFolder">çˆ¶æ–‡ä»¶å¤¹:</label>
            <select id="parentFolder">
                <option value="0">æ ¹æ–‡ä»¶å¤¹</option>
            </select>
        </div>
        <div class="form-group">
            <label for="deleteFolder">åˆ é™¤æ–‡ä»¶å¤¹:</label>
            <select id="deleteFolder">
                <option value="">é€‰æ‹©è¦åˆ é™¤çš„æ–‡ä»¶å¤¹</option>
            </select>
        </div>
        <button onclick="createFolder()">åˆ›å»ºæ–‡ä»¶å¤¹</button>
        <button onclick="deleteSelectedFolder()">åˆ é™¤æ–‡ä»¶å¤¹</button>
        <button onclick="loadFolders()">åˆ·æ–°æ–‡ä»¶å¤¹åˆ—è¡¨</button>
        <div id="folderResult" class="result" style="display:none;"></div>
    </div>

    <!-- APIçŠ¶æ€æ£€æŸ¥ -->
    <div class="container api-section">
        <h2>ğŸ¥ ç³»ç»ŸçŠ¶æ€</h2>
        <button onclick="checkHealth()">æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€</button>
        <div id="healthResult" class="result" style="display:none;"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080';

        // æ£€æŸ¥æœåŠ¡å™¨å¥åº·çŠ¶æ€
        async function checkHealth() {
            try {
                const response = await fetch(`${API_BASE}/ping`);
                const data = await response.json();
                showResult('healthResult', `âœ… æœåŠ¡å™¨è¿è¡Œæ­£å¸¸: ${data.message}`, 'success');
            } catch (error) {
                showResult('healthResult', `âŒ æœåŠ¡å™¨è¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // ä¸Šä¼ æˆªå›¾
        async function uploadImage() {
            const fileInput = document.getElementById('imageFile');
            const timestampInput = document.getElementById('screenshotTimestamp');
            const appNameInput = document.getElementById('screenshotAppName');
            const tagsInput = document.getElementById('screenshotTags');
            
            if (!fileInput.files[0]) {
                showResult('uploadResult', 'âŒ è¯·é€‰æ‹©ä¸€ä¸ªå›¾ç‰‡æ–‡ä»¶', 'error');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = async function(e) {
                const base64 = e.target.result.split(',')[1];
                
                // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆ
                const preview = document.getElementById('imagePreview');
                preview.src = e.target.result;
                preview.style.display = 'block';
                
                // æ„å»ºè¯·æ±‚ä½“
                const requestBody = {
                    screenshotFileBlob: base64
                };
                
                // æ·»åŠ å¯é€‰å­—æ®µ
                if (timestampInput.value) {
                    requestBody.screenshotTimestamp = parseInt(timestampInput.value);
                }
                if (appNameInput.value.trim()) {
                    requestBody.screenshotAppName = appNameInput.value.trim();
                }
                if (tagsInput.value.trim()) {
                    requestBody.screenshotTags = tagsInput.value.trim();
                }
                
                try {
                    const response = await fetch(`${API_BASE}/upload`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(requestBody)
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        let resultText = `âœ… ä¸Šä¼ æˆåŠŸ!\n` +
                            `å¯¹è±¡ID: ${data.object_id}\n` +
                            `æ–‡ä»¶å¤¹ID: ${data.folder_id}\n` +
                            `æè¿°: ${data.description}\n` +
                            `æ‘˜è¦: ${data.digest}`;
                        
                        if (data.screenshot_timestamp) {
                            resultText += `\næ—¶é—´æˆ³: ${data.screenshot_timestamp}`;
                        }
                        if (data.screenshot_app_name) {
                            resultText += `\nåº”ç”¨åç§°: ${data.screenshot_app_name}`;
                        }
                        if (data.screenshot_tags) {
                            resultText += `\næ ‡ç­¾: ${data.screenshot_tags}`;
                        }
                        
                        showResult('uploadResult', resultText, 'success');
                    } else {
                        showResult('uploadResult', `âŒ ä¸Šä¼ å¤±è´¥: ${data.error}`, 'error');
                    }
                } catch (error) {
                    showResult('uploadResult', `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
                }
            };
            
            reader.readAsDataURL(file);
        }

        // æœç´¢å›¾ç‰‡
        async function searchImages() {
            const query = document.getElementById('searchQuery').value;
            const limit = document.getElementById('searchLimit').value;
            
            if (!query.trim()) {
                showResult('searchResult', 'âŒ è¯·è¾“å…¥æœç´¢æŸ¥è¯¢', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/search`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        limit: parseInt(limit)
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    let resultText = `âœ… æœç´¢å®Œæˆï¼Œæ‰¾åˆ° ${data.count} ä¸ªç»“æœ:\n\n`;
                    data.results.forEach((obj, index) => {
                        resultText += `${index + 1}. å¯¹è±¡ID: ${obj.object_id}\n`;
                        resultText += `   æ–‡ä»¶å¤¹ID: ${obj.folder_id}\n`;
                        resultText += `   ç›¸ä¼¼åº¦: ${(obj.similarity * 100).toFixed(2)}%\n`;
                        resultText += `   æè¿°: ${obj.description.substring(0, 100)}...\n\n`;
                    });
                    showResult('searchResult', resultText, 'success');
                } else {
                    showResult('searchResult', `âŒ æœç´¢å¤±è´¥: ${data.error}`, 'error');
                }
            } catch (error) {
                showResult('searchResult', `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åˆ›å»ºæ–‡ä»¶å¤¹
        async function createFolder() {
            const name = document.getElementById('folderName').value;
            const parent = document.getElementById('parentFolder').value;
            
            if (!name.trim()) {
                showResult('folderResult', 'âŒ è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/folder`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: name,
                        upper: parseInt(parent)
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showResult('folderResult', `âœ… ${data.message}ï¼ŒID: ${data.id}`, 'success');
                    loadFolders(); // åˆ·æ–°æ–‡ä»¶å¤¹åˆ—è¡¨
                } else {
                    showResult('folderResult', `âŒ åˆ›å»ºå¤±è´¥: ${data.error}`, 'error');
                }
            } catch (error) {
                showResult('folderResult', `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é€’å½’è·å–æ‰€æœ‰æ–‡ä»¶å¤¹
        async function getAllFolders(folderId = 0, level = 0) {
            try {
                const response = await fetch(`${API_BASE}/folder/${folderId}`);
                const data = await response.json();
                
                if (!response.ok) {
                    return [];
                }
                
                let allFolders = [];
                
                // æ·»åŠ å½“å‰å±‚çº§çš„æ–‡ä»¶å¤¹
                if (data.subfolders) {
                    for (const folder of data.subfolders) {
                        allFolders.push({
                            id: folder.id,
                            name: folder.name,
                            level: level
                        });
                        
                        // é€’å½’è·å–å­æ–‡ä»¶å¤¹
                        const subFolders = await getAllFolders(folder.id, level + 1);
                        allFolders = allFolders.concat(subFolders);
                    }
                }
                
                return allFolders;
            } catch (error) {
                console.error(`è·å–æ–‡ä»¶å¤¹ ${folderId} å¤±è´¥:`, error);
                return [];
            }
        }

        // åŠ è½½æ–‡ä»¶å¤¹åˆ—è¡¨
        async function loadFolders() {
            try {
                const allFolders = await getAllFolders();
                updateFolderSelects(allFolders);
                showResult('folderResult', `âœ… æ–‡ä»¶å¤¹åˆ—è¡¨å·²åˆ·æ–°ï¼Œå…±åŠ è½½ ${allFolders.length} ä¸ªæ–‡ä»¶å¤¹`, 'success');
            } catch (error) {
                console.error('åŠ è½½æ–‡ä»¶å¤¹å¤±è´¥:', error);
                showResult('folderResult', `âŒ åŠ è½½æ–‡ä»¶å¤¹å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åˆ é™¤é€‰ä¸­çš„æ–‡ä»¶å¤¹
        async function deleteSelectedFolder() {
            const folderId = document.getElementById('deleteFolder').value;
            
            if (!folderId) {
                showResult('folderResult', 'âŒ è¯·é€‰æ‹©è¦åˆ é™¤çš„æ–‡ä»¶å¤¹', 'error');
                return;
            }
            
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶å¤¹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/folder/${folderId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showResult('folderResult', `âœ… ${data.message}`, 'success');
                    loadFolders(); // åˆ·æ–°æ–‡ä»¶å¤¹åˆ—è¡¨
                } else {
                    showResult('folderResult', `âŒ åˆ é™¤å¤±è´¥: ${data.error}`, 'error');
                }
            } catch (error) {
                showResult('folderResult', `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ›´æ–°æ–‡ä»¶å¤¹é€‰æ‹©å™¨
        function updateFolderSelects(folders) {
            const selects = ['parentFolder'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    // ä¿ç•™æ ¹æ–‡ä»¶å¤¹é€‰é¡¹
                    select.innerHTML = '<option value="0">æ ¹æ–‡ä»¶å¤¹</option>';
                    
                    folders.forEach(folder => {
                        const option = document.createElement('option');
                        option.value = folder.id;
                        // æ ¹æ®å±‚çº§æ·»åŠ ç¼©è¿›
                        const indent = 'ã€€'.repeat(folder.level); // ä½¿ç”¨å…¨è§’ç©ºæ ¼ä½œä¸ºç¼©è¿›
                        option.textContent = indent + folder.name;
                        select.appendChild(option);
                    });
                }
            });
            
            // æ›´æ–°åˆ é™¤æ–‡ä»¶å¤¹ä¸‹æ‹‰æ¡†ï¼ˆä¸åŒ…å«æ ¹æ–‡ä»¶å¤¹ï¼‰
            const deleteSelect = document.getElementById('deleteFolder');
            deleteSelect.innerHTML = '<option value="">é€‰æ‹©è¦åˆ é™¤çš„æ–‡ä»¶å¤¹</option>';
            
            folders.forEach(folder => {
                const option = document.createElement('option');
                option.value = folder.id;
                // æ ¹æ®å±‚çº§æ·»åŠ ç¼©è¿›
                const indent = 'ã€€'.repeat(folder.level); // ä½¿ç”¨å…¨è§’ç©ºæ ¼ä½œä¸ºç¼©è¿›
                option.textContent = indent + folder.name;
                deleteSelect.appendChild(option);
            });
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `result ${type}`;
            element.style.display = 'block';
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€å’ŒåŠ è½½æ–‡ä»¶å¤¹
        window.onload = function() {
            checkHealth();
            loadFolders();
        };
    </script>
</body>
</html>